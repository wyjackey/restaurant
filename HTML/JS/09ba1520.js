!function(){var a=function(){"use strict";function a(a){this.tagNames=[a||null],this.buffer="",this.id=null,this.className=null,this.style=null}var b;return a.prototype.begin=function(a){this.tagNames.push(a||null)},a.prototype.push=function(a){this.buffer+=a},a.prototype.pushOpenTag=function(){var a=this.getCurrentTag(),b=this.id,c=this.className,d=this.style;this.buffer+="<"+a,b&&(this.buffer+=' id="'+this.id+'"',this.id=null),c&&(this.buffer+=' class="'+this.className+'"',this.className=null),d&&(this.buffer+=' style="'+this.style+'"',this.style=null),this.buffer+=">"},a.prototype.pushCloseTag=function(){var a=this.tagNames.pop();this.buffer+="</"+a+">"},a.prototype.setId=function(a){return this.id=a,this},a.prototype.setClass=function(a){return this.className=a,this},a.prototype.setStyle=function(a){return this.style=a,this},a.prototype.getCurrentTag=function(){return this.tagNames[this.tagNames.length-1]},b=a}(),b=function(){"use strict";var a,b={on:function(a,b,c){var d=this.getEvents();"string"==typeof a&&b&&"function"==typeof b&&(d[a]||(d[a]=[]),d[a].push({callback:b,context:c}))},off:function(a,b){var c=this.getEvents();if(!a&&!b)return void(this.events={});if(c[a]){if(c[a]&&!b)return void delete c[a];for(var d,e=[],f=c[a],g=f.length;g--;)d=f[g],d&&d.callback!==b&&e.push(d);0===e.length?delete c[a]:c[a]=e}},once:function(a,b,c){var d,e=this,f=this.getEvents();f[a]||(f[a]=[]),d=function(){e.off(a,d),b.apply(this,arguments)},f[a].push({callback:d,context:c})},trigger:function(a){var b,c,d=this.getEvents(),e=d[a],f=Array.prototype.slice.call(arguments,1);if(!e||0===e.length)return void(window.console&&"function"==typeof window.console.log&&console.log("no one subscribe topic",a));for(b=e.length;b--;)c=e[b].callback.apply(e[b].context,f);return c},listenTo:function(a,b,c,d){"object"==typeof a&&"function"==typeof a.on&&a.on(b,c,d)},stopListening:function(a,b,c){"object"==typeof a&&"function"==typeof a.off&&a.off(b,c)},getEvents:function(){return this.events||(this.events={})}};return a=b}(),c=function(a){"use strict";function b(){}var c,d=a;b.prototype=d,b.prototype.constructor=b,b.prototype.publish=d.trigger,b.prototype.subscribe=d.on,b.prototype.cancelSub=d.off,b.prototype.subscribeOnce=d.once,b.prototype.subscribeMany=function(a,b,c){if("[object Array]"===Object.prototype.toString.call(a)&&0!==a.length){var d,e,f,g=this,h=[],i=a.join("-");for(d=a.length;d--;)!function(b){g.subscribeOnce(a[d],function(){if(1===h.length)g.publish(i);else for(e=h.length;e--;)h[e]===b&&h.splice(e,e+1)})}(a[d]),h.push(a[d]);f=function(){b.call(c),g.cancelSub(i)},this.subscribe(i,f,c)}};var e=new b;return c=e}(b),d=function(){"use strict";var a,b={multiply:function(a,b){var c,d,e=0;return c=(a+"").split("."),d=(b+"").split("."),2===c.length&&(e+=c[1].length,a*=Math.pow(10,c[1].length)),2===d.length&&(e+=d[1].length,b*=Math.pow(10,d[1].length)),a*b/Math.pow(10,e)},add:function(a,b){var c,d,e=0;return c=(a+"").split("."),d=(b+"").split("."),2===c.length&&(e=Math.max(c[1].length,e)),2===d.length&&(e=Math.max(d[1].length,e)),e?(a*=Math.pow(10,e),b*=Math.pow(10,e),(a+b)/Math.pow(10,e)):a+b},inherit:function(a,b){function c(){}if(!a)throw new Error("lack of destination class");if(b=b||Function,"function"!=typeof a)throw new Error("Dest need to be function");return c.prototype=b.prototype,a.prototype=new c,a._super=b,a.prototype.constructor=a,a}};return a=b}(),e=function(){"use strict";var a;_.templateSettings.variable="data";var b={},c=function(a){this.templateId=a,this.compiledTemplate=null};c.prototype.load=function(){if(this.compiledTemplate)return this.compiledTemplate;var a=this.loadTemplate(this.templateId);return this.compiledTemplate=this.compileTemplate(a),this.compiledTemplate},c.prototype.loadTemplate=function(a){var b=$(a).html();return $(a).remove(),b},c.prototype.compileTemplate=function(a){return _.template(a)};var d={get:function(a){var d=b[a];return d||(d=new c(a),b[a]=d),d.load()}};return a=d}(),f=function(){"use strict";function a(a){for(var b in a)if("success"===b||"error"===b)throw new Error("dont't use success and error callback in request options, use done, fail, or then")}var b,c={request:function(b){return a(b),b.data=b.data||{},ELEME.csrfToken&&(b.data.csrf_token=ELEME.csrfToken),$.ajax(b).then(function(a,b,c){if(arguments.length){var d=$.Deferred();return"ok"===a.status?d.resolveWith(null,[a.data,b,c]):"error"===a.status?d.rejectWith(null,[a.error,b,c]):void 0}},function(a,b,c){var d=$.Deferred(),e={code:-1,msg:"请求出错"};return d.rejectWith(null,[e,b,a])})}};return b=c}(),g=function(){"use strict";var a,b={email:/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$/i,tel:/^([2-9]\d{2,7})(-\d{3,5})*$/,cellphone:/^1[34578]\d{9}$/,fulltel:/^([2-9]\d{6,7})(-\d{3,5})*$/};return a=b}(),h=function(){"use strict";var a,b={format:function(a){a*=1e3;var b,c,d,e=new Date(a),f=new Date,g=f.getTime();return f.setHours(0,0,0,0),c=f.getTime(),f.setTime(c-864e5),d=f.getTime(),b=g-a,6e4>b?"刚刚":36e5>b?Math.round(b/6e4)+"分钟前":e.getTime()>c?Math.round(b/36e5)+"小时前":c>a&&a>d?"昨天":e.getFullYear()===f.getFullYear()?e.getMonth()+1+"月"+e.getDate()+"日":e.getFullYear()+"年"+(e.getMonth()+1)+"月"+e.getDate()+"日"}};return a=b}(),i=function(){"use strict";var a,b={getItem:function(a){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(a,b,c,d,e,f){if(!a||/^(?:expires|max\-age|path|domain|secure)$/i.test(a))return!1;var g="";if(c)switch(c.constructor){case Number:g=c===1/0?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+c;break;case String:g="; expires="+c;break;case Date:g="; expires="+c.toUTCString()}return document.cookie=encodeURIComponent(a)+"="+encodeURIComponent(b)+g+"; domain="+(e?e:ELEME.rootHost)+(d?"; path="+d:"")+(f?"; secure":""),!0},removeItem:function(a,b,c){return a&&this.hasItem(a)?(document.cookie=encodeURIComponent(a)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; domain=."+(c?c:ELEME.rootHost)+(b?"; path="+b:""),!0):!1},hasItem:function(a){return new RegExp("(?:^|;\\s*)"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)},keys:function(){for(var a=document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g,"").split(/\s*(?:\=[^;]*)?;\s*/),b=0;b<a.length;b++)a[b]=decodeURIComponent(a[b]);return a}};return a=b}(),j=function(){"use strict";var a,b=window.devicePixelRatio>1?2:1,c=function(){var a=$.Deferred(),b=new Image;return b.onload=function(){a.resolve(!0)},b.onerror=function(){a.resolve(!1)},b.src="data:image/webp;base64,UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAsAAAABBxAREYiI/gcAAABWUDggGAAAADABAJ0BKgEAAQABABwlpAADcAD+/gbQAA==",a.promise()},d=c(),e=function(a,c,e){return d.then(function(d){var f=d?"/format/webp/quality/85":"",g=a+"?imageMogr2"+f,h="/thumbnail/"+c+"x"+e,i="/thumbnail/"+2*c+"x"+2*e;return b>1?g+i:g+h})};return a=e}();!function(a,b,c,d,e,f,g,h,i,j){"use strict";var k=a,l=b,m=c,n=d,o=e,p=f,q=g,r=h,s=i,t=j;"undefined"==typeof Eleme&&(window.Eleme={}),Eleme.Common={RenderBuffer:k,Evt:l,Util:n,Time:r,Http:p,PubSub:m,Regex:q,Cookie:s,optimizeImgUrl:t,TemplateCache:o}}(a,b,c,d,e,f,g,h,i,j)}(),function(){!function(){"use strict";if($(".eleme_dropdown:not(#topbar_msg)").uDropdown(),$('input:not([type="password"]), textarea').placeholder(),$('[data-toggle="bs-tooltip"]').tooltip({animation:!1,placement:"top",delay:{show:700,hide:0},container:"body"}),$("#mod_fixed").length>0){var a=$("#mod_fixed");Eleme.Component.scrollspy("fixedMod",{min:300,onEnter:function(){a.find("#back_top").removeClass("ui_invisible")},onLeave:function(){a.find("#back_top").addClass("ui_invisible")}}),$("#back_top").on("click",function(){$("html, body").animate({scrollTop:"0px"},300)})}var b={feedbackUrl:"/feedback/addSuggestion",feedbackModalSelector:"#modal_feedback",feedbackInputSelector:"#feedback_input",feedbackFormSelector:"#feedback_form",feedbackErrorSelector:".feedback_err_tip",cancelFeedbackSelector:".cancel_feedback",submitFeedbackSelector:".submit_feedback"};$(b.feedbackFormSelector).on("submit",function(a){var c="http://"+ELEME.mainHost+b.feedbackUrl,d=$.trim($(b.feedbackInputSelector).val());return a.preventDefault(),""===d?void $(b.feedbackErrorSelector).html("亲爱的用户，您还没有添加反馈意见").removeClass("hide"):($(b.submitFeedbackSelector).html("正在提交"),void Eleme.Common.Http.request({url:c,type:"get",dataType:"jsonp",data:{content:d}}).done(function(a,c,d){$(b.feedbackModalSelector).modal("hide"),$(b.feedbackInputSelector).val(""),$(b.feedbackErrorSelector).html("").addClass("hide"),$(b.submitFeedbackSelector).html("提交")}).fail(function(a){$(b.feedbackErrorSelector).html(a.msg).removeClass("hide"),$(b.submitFeedbackSelector).html("提交")}))}),$(b.cancelFeedbackSelector).on("click",function(){$(b.feedbackErrorSelector).addClass("hide").html("")}),~function(){var a=[],b=0,c=function(){if(!(b>4||a.length<=0)){b++;var c=a.shift();c[0].attr("src",c[1])}};$.fn.srcset=function(){return $(this).each(function(d,e){var f=$(e),g=f.attr("data-srcset"),h=+f.attr("width"),i=+f.attr("height");f.removeAttr("data-srcset"),Eleme.Common.optimizeImgUrl(g,h,i).then(function(d){a.push([f,d]),c(),e.onload=function(){b--,c()},e.onerror=function(){b--,c()}})})}}(jQuery)}()}(),function(){var a=function(){"use strict";function a(a){this.$el=null,this.local=!1,this.searchResault={},this.init(a)}var b,c=Eleme.Common.Http,d=Eleme.Common.PubSub,e={searchPanelSelector:"#topbar_search",searchFormSelector:"#tsearch_form",resaultWrapSelector:"#tsearch_autocomplete",localLabelSelector:".ts_inRst",removeLocalLabelSelector:"#ts_remove",searchInputSelector:"#tsearch_input",singleFoodSelector:".tsearch-item",loadingSpinSelector:"#ts_loading",iconSearchSelector:"#icon_tsearch",searchClearSelector:"#ts_clear",filterFoodTopic:"filterFood",searchSuccessTopic:"restaurantSearchSuccess",searchFailureTopic:"restaurantSearchFailure",foodScrollTopic:"foodScroll",emptyTip:'<div class="tsearch-no-result">没有找到相关的美食</div>',foodContainer:['<div class="group">','<span class="tsearch-cate">美食</span>','<ul class="tsearch-list"></ul>',"</div>"].join(""),restaurantContainer:['<div class="group">','<span class="tsearch-cate">餐厅</span>','<ul class="tsearch-list"></ul>',"</div>"].join(""),inRestaurantTpl:['<span class="ts_inRst tsearch-in-rst">','<i class="glyph-search"></i>搜本店<a id="ts_remove" class="action-remove">×</a>',"</span>"].join(""),foodTpl:['<li class="tsearch-item ts-dish">','<a class="tsd-name" data-foodid="<%- data.id %>"><%- data.name %></a>','<span class="tsd-price"><span class="symbol-rmb"></span><%- data.price %></span>',"</li>"].join(""),globalFoodTpl:['<li class="tsearch_item tsearch-item ts-dish">','<a class="tsd-name" href="<%- "//" + "r" + "." + ELEME.rootHost + "/" + data.restaurantNameForUrl + "#food/" + data.id %>" target="_blank"><%- data.name %></a>','<a class="tsd-rst" href="<%- "//" + data.restaurantNameForUrl + "." + ELEME.rootHost %>" target="_blank"><%- data.restaurantName %></a>','<span class="tsd-price">','<span class="symbol-rmb"><%- data.price %></span>',"</span>","</li>"].join(""),globalRestaurantTpl:['<li class="tsearch_item">','<a class="tsearch-item ts-restaurant" href="<%- "//" + "r" + "." + ELEME.rootHost + "/" + data.nameForUrl %>" target="_blank">','<img class="tsr-logo" src="<%- ELEME.fussHost + data.logo %>" alt="" />','<span class="tsr-name"><%- data.name %></span>','<% if (data.deliverTime) { %><span class="tsr-time"><%- data.deliverTime %>分钟</span><% } %>',"</a>","</li>"].join(""),local:!1,activeClass:"ui_open",searchUrl:"/search/suggestion",restaurantTag:"restaurant_show"};return a.prototype.init=function(){this.$el=$(e.searchPanelSelector),this.subscribeTopic(),this.bindEvents(),ELEME.route===e.restaurantTag&&this.changeToInRestaurant()},a.prototype.subscribeTopic=function(){d.subscribe(e.searchSuccessTopic,function(a){this.$el.find(e.loadingSpinSelector).addClass("hide").siblings(e.searchClearSelector).removeClass("hide"),this.parseResault(a)},this),d.subscribe(e.searchFailureTopic,function(a){})},a.prototype.bindEvents=function(){var a=this;this.$el.on("keyup",e.searchInputSelector,$.proxy(this.handleType(),this)),this.$el.on("click",e.removeLocalLabelSelector,$.proxy(this.changeToNomal,this)),this.$el.on("click",e.singleFoodSelector,function(b){var c=$(b.currentTarget).find(".tsd-name"),f=window.parseInt(c.data("foodid"),10);this.local?ga("send","event","topbarSearch","searchBoxActive","inRestaurant"):ga("send","event","topbarSearch","searchBoxActive","global"),d.publish(e.foodScrollTopic,f),a.$el.find(e.searchInputSelector).val(""),a.$el.find(e.searchFormSelector).removeClass("focus"),a.$el.find(e.resaultWrapSelector).removeClass(e.activeClass).hide(),a.$el.find(e.searchClearSelector).addClass("hide")}),this.$el.on("click",e.searchClearSelector,function(){a.$el.find(e.searchInputSelector).val(""),$(this).addClass("hide")}),$(document).on("click",function(b){var c=b.target,d=a.$el[0],f=a.$el.find(e.resaultWrapSelector);f.hasClass(e.activeClass)&&($.contains(d,c)||(a.$el.find(e.searchFormSelector).removeClass("focus"),f.removeClass(e.activeClass).hide(),a.$el.find(e.searchClearSelector).addClass("hide")))}),this.$el.on("focus",e.searchInputSelector,function(b){var c=a.$el.find(e.searchFormSelector),d=a.$el.find(e.resaultWrapSelector);return d.hasClass(e.activeClass)?!1:(d.addClass(e.activeClass),c.addClass("focus"),void b.stopPropagation())}),this.$el.find(e.searchFormSelector).on("submit",function(){var a=$(this).find(e.searchInputSelector).val();a=encodeURIComponent(a);var b=$("meta[name=geohash]").attr("content");return window.location.href=ELEME.formerBaseUrl+"/place/"+b+"/search/"+a,!1})},a.prototype.changeToInRestaurant=function(){this.$el.addClass("ui_in_rst").find(e.iconSearchSelector).addClass("hide"),this.$el.find(e.iconSearchSelector).after($(e.inRestaurantTpl)),this.$el.find(e.searchInputSelector).attr("placeholder","美食"),this.local=!0},a.prototype.changeToNomal=function(){this.$el.removeClass("ui_in_rst").find(e.localLabelSelector).remove(),this.$el.find(e.iconSearchSelector).removeClass("hide"),this.$el.find(e.searchInputSelector).attr("placeholder","搜索餐厅,美食"),this.local=!1},a.prototype.handleType=function(){var a;return function(){var b=this.$el.find(e.searchInputSelector).val();a!==$.trim(b)&&(this.local?d.publish(e.filterFoodTopic,{keyword:b},$.proxy(this.parseResault,this)):this.search({wd:b}),a=b)}},a.prototype.search=function(a){var b="//"+ELEME.mainHost+e.searchUrl;this.$el.find(e.loadingSpinSelector).removeClass("hide").siblings(e.searchClearSelector).addClass("hide"),c.request({type:"get",url:b,data:a,dataType:"jsonp"}).done(function(a,b,c){d.publish(e.searchSuccessTopic,a),a.foods.length>0||a.restaurant.length>0?ga("send","event","topbarSearch","hasResult","global",a.foods.length+a.restaurant.length):ga("send","event","topbarSearch","noResult","global",0)}).fail(function(a){d.publish(e.searchFailureTopic,a.msg)})},a.prototype.parseResault=function(a){a.food=a.foods||[],a.restaurant=a.restaurants||[],this.searchResault=a,this.buildResaultContent()},a.prototype.buildResaultContent=function(){var a,b,c,d,f,g,h="",i="",j=this.searchResault.food,k=this.searchResault.restaurant,l=$(e.foodContainer),m=$(e.restaurantContainer),n=this.$el.find(e.resaultWrapSelector);if(n.empty(),this.local?f=_.template(e.foodTpl):(g=_.template(e.globalRestaurantTpl),f=_.template(e.globalFoodTpl)),0===j.length&&0===k.length)return void n.append(e.emptyTip).show();if(0!==k.length){for(b=0,d=k.length;d>b;b++)i+=g(k[b]);m.children("ul").append(i),n.append(m)}if(0!==j.length){for(a=0,c=j.length;c>a;a++)h+=f(j[a]);l.children("ul").append(h),n.append(l)}n.show()},b=a}(),b=function(){"use strict";function a(){this.$el=null,this.pullId=null,this.active=!1,this.working=!1,this.currentUnread=0,this.init()}var b,c=Eleme.Common.Http,d=Eleme.Common.PubSub,e={topbarMsgSelector:"#topbar_msg",msgTotalSelector:"#tmsg_total",msgContainerSelector:"#tmsg_wrapper",msgLoadingSelector:"#tmsg_loading",clearBtnSelector:"#tmsg_clear",singleMsgSelector:".tmsg_item",msgFetchErrorTopic:"msgFetchError",msgFetchDoneTopic:"msgFetchDone",unreadMsgTopic:"unreadMsg",userAuthTopic:"userAuth",msgTpl:['<a class="tmsg-item tmsg_item" data-id="<%- data.id %>" href="<%- data.url %>" target="_blank">','<h4 class="tmsg-title" title="<%- data.abstract %>"><%- data.abstract %></h4>','<span class="tmsg-time"><%- data.createdAt %></span>','<p class="tmsg-content"><%- data.content %></p>',"</a>"].join(""),noMsgHintTpl:'<div id="tmsg_empty" class="twidget-empty">没有新信息</div>',msgClearBtnTpl:'<div class="twidget-footer"><a id="tmsg_clear" class="twidget-btn">知道了</a></div>',msgUrl:"/topbar/message",msgReadUrl:"/topbar/read/message",syncTimeStamp:6e6};return a.prototype.init=function(){this.$el=$(e.topbarMsgSelector),this.bindEvents(),this.subscribeTopic()},a.prototype.subscribeTopic=function(){d.subscribe(e.msgFetchDoneTopic,this.parseMsgData,this),d.subscribe(e.msgFetchErrorTopic,this.parseMsgData,this),d.subscribe(e.userAuthTopic,this.toggle,this),d.subscribe(e.unreadMsgTopic,this.updateMsgInfo,this)},a.prototype.bindEvents=function(){var a=this;this.$el.uDropdown($.proxy(this.fetch,this),$.proxy(this.empty,this)),this.$el.on("click",e.clearBtnSelector,function(){a.markAsRead({payLoad:"/all",type:"all",success:function(){this.$el.trigger("click").find(e.msgTotalSelector).html(0).hide()}})}),this.$el.on("click",e.singleMsgSelector,function(b){var c=$(b.currentTarget);a.markAsRead({payLoad:"/"+c.data("id"),type:"single",success:function(){0===this.currentUnread&&this.$el.trigger("click").find(e.msgTotalSelector).html(0).hide(),c.remove(),this.$el.find(e.msgTotalSelector).html(this.currentUnread)}})})},a.prototype.fetch=function(){var a="//"+ELEME.mainHost+e.msgUrl;c.request({type:"get",url:a,dataType:"jsonp"}).done(function(a,b,c){d.publish(e.msgFetchDoneTopic,a)}).fail(function(a){d.publish(e.msgFetchErrorTopic,a.msg)})},a.prototype.toggle=function(a){a.authed?(this.working=!0,this.$el.removeClass("hide"),window.setTimeout($.proxy(function(){this.pullId||(this.pullId=window.setInterval($.proxy(this.pull,this),1e4))},this),e.syncTimeStamp)):(this.working=!1,this.$el.addClass("hide"))},a.prototype.empty=function(){this.active=!1,this.$el.find(e.msgLoadingSelector).show(),this.$el.find(e.msgContainerSelector).empty()},a.prototype.pull=function(){var a,b,f=this,g=(new Date).getTime(),h="//"+ELEME.mainHost+e.msgUrl+"/count";a=window.localStorage.getItem("updateTimeStamp"),b=window.localStorage.getItem("unread"),g-a>e.syncTimeStamp?c.request({type:"get",url:h,dataType:"jsonp"}).done(function(a){f.storeToLocal(a),d.publish(e.unreadMsgTopic,a)}).fail(function(a){}):d.publish(e.unreadMsgTopic,b)},a.prototype.updateMsgInfo=function(a){this.active||this.currentUnread==a||(this.currentUnread=a,this.$el.find(e.msgTotalSelector).html(a),a>0?this.$el.find(e.msgTotalSelector).css("display","block"):0===a&&this.$el.find(e.msgTotalSelector).css("display","none"))},a.prototype.parseMsgData=function(a){a=a||[];var b,c=_.template(e.msgTpl),f=this.$el.find(e.msgContainerSelector);if(f.empty(),this.storeToLocal(this.currentUnread),d.publish(e.unreadMsgTopic,a.length),this.active=!0,this.$el.find(e.msgLoadingSelector).hide(),0===a.length)return void f.append(e.noMsgHintTpl);for(b=a.length;b--;)f.append(c(a[b]));f.append(e.msgClearBtnTpl)},a.prototype.markAsRead=function(a){var b,d,f,g=this;a&&(d=a.payLoad,f=a.success,d&&f&&"function"==typeof f&&(b="//"+ELEME.mainHost+e.msgReadUrl+d,c.request({type:"get",url:b,dataType:"jsonp"}).done(function(b,c,d){b.success&&("all"===a.type?g.currentUnread=0:g.currentUnread--,g.storeToLocal(g.currentUnread),a.success.call(g))}).fail(function(a){})))},a.prototype.storeToLocal=function(a){window.localStorage&&(window.localStorage.setItem("unread",a),window.localStorage.setItem("updateTimeStamp",(new Date).getTime()))},a.prototype.showErrorTip=function(a){this.$el.find(e.msgLoadingSelector).hide()},b=a}(),c=function(){"use strict";function a(){this.$el=null,this.topbarInfo={},this.init()}var b,c=Eleme.Common.Http,d=Eleme.Common.PubSub,e={topbarWrapSelector:"#topbar",cartTotalSelector:"#tcart_total",msgTotalSelector:"#tmsg_total",userNameSelector:"#t_username",userNameWrapSelector:"#topbar_username",loginWrapSelector:"#topbar_logreg",msgWrapSelector:"#topbar_msg",cartWrapSelector:"#topbar_cart",dpLinkSelector:"#tdp_link",logoutSelector:"#topbar_logout",userAuthTopic:"userAuth",userInfoDoneTopic:"userInfoDone",userInfoUrl:"/topbar/userinfo",logoutUrl:"http://"+ELEME.accountHost+"/logout"};return a.prototype.init=function(){this.$el=$(e.topbarWrapSelector),d.subscribe(e.userInfoDoneTopic,this.updateUserInfo,this),d.subscribe(e.userInfoDoneTopic,this.traceUserBehavior,this)},a.prototype.fetch=function(){var a="//"+ELEME.mainHost+e.userInfoUrl;c.request({url:a,type:"get",dataType:"jsonp"}).done(function(a,b,c){d.publish(e.userInfoDoneTopic,a)}).fail(function(a){})},a.prototype.updateUserInfo=function(a){this.topbarInfo=a,this.topbarInfo.authenticated?(ELEME.authed=!0,this.$el.find(e.userNameSelector).html(this.topbarInfo.username),this.$el.find(e.userNameWrapSelector).removeClass("hide"),this.$el.find(e.loginWrapSelector).addClass("hide"),this.topbarInfo.message>0&&(this.$el.find(e.msgTotalSelector).html(this.topbarInfo.message).closest(e.msgWrapSelector).removeClass("empty"),window.localStorage.setItem("unread",this.topbarInfo.message),window.localStorage.setItem("updateTimeStamp",(new Date).getTime()))):(ELEME.authed=!1,this.$el.find(e.msgWrapSelector).addClass("hide")),this.topbarInfo.cart>0&&this.$el.find(e.cartTotalSelector).html(this.topbarInfo.cart).closest(e.cartWrapSelector).removeClass("empty"),this.topbarInfo.position&&this.$el.find(e.dpLinkSelector).removeClass("hide").attr("href","http://t.dianping.com/home?distance=500&latitude="+this.topbarInfo.position.latitude+"&longitude="+this.topbarInfo.position.longitude),d.publish(e.userAuthTopic,{authed:this.topbarInfo.authenticated})},a.prototype.traceUserBehavior=function(a){UBT.send("PARAMS",{user_id:a.userid,geohash:a.geohash})},b=a}();!function(a,b,c){"use strict";var d=a,e=b,f=c,g=(new d,new e,new f);g.fetch()}(a,b,c)}();